<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Klaedes Advisory — FuelEU Pooling (Demo)</title>
<style>
  :root{
    --bg:#0b1420; --panel:#0f1c2e; --line:#1c2a3d;
    --text:#e6f1ff; --muted:#9cb3cc;
    --primary:#2f6df6; --primary-2:#1c3fa3; --accent:#00b8d9;
    --ok:#33d69f; --warn:#ffb020; --bad:#ff5c5c;
    --row-green:#0b261c; --row-red:#2a0d0d;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
  header{display:flex;align-items:center;gap:14px;padding:14px 18px;border-bottom:1px solid var(--line);background:#0d1829;position:sticky;top:0;z-index:5}
  .brand{display:flex;align-items:center;gap:10px}
  .logo{width:40px;height:40px;border:2px dashed #254165;border-radius:8px;display:flex;align-items:center;justify-content:center;color:#7bb2e6;font-size:10px}
  h1{margin:0;font-size:16px;font-weight:800}
  .sub{color:var(--muted);font-size:12px}
  .demo-bar{display:flex;gap:8px;margin-left:auto;align-items:center}
  .demo-pill{font-size:12px;border:1px solid var(--line);padding:6px 10px;border-radius:999px;background:#0b1a2a;color:#c8dbf5}
  .wrap{display:flex;min-height:100vh}
  nav{width:290px;border-right:1px solid var(--line);padding:16px;background:#0d1a2b;position:sticky;top:69px;height:calc(100vh - 69px);overflow:auto}
  .navtitle{font-size:12px;color:var(--muted);margin:8px}
  .nav button{display:block;width:100%;text-align:left;border:1px solid var(--line);background:#0f1c2e;color:var(--text);padding:10px 12px;border-radius:10px;margin:6px 0;font-size:14px;cursor:pointer}
  .nav button.active{border-color:var(--primary);box-shadow:0 0 0 3px rgba(47,109,246,.18) inset}
  main{flex:1;max-width:1100px;margin:0 auto;padding:20px}
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:18px;box-shadow:0 8px 28px rgba(4,12,22,.35);margin-bottom:16px}
  h2{font-size:18px;margin:6px 0 10px} h3{font-size:16px;margin:0 0 8px}
  p.muted{color:var(--muted);font-size:13px;margin:6px 0 12px}
  label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
  input,select,textarea{width:100%;padding:10px 12px;background:#0b1a2a;border:1px solid var(--line);border-radius:10px;color:var(--text);font-size:14px}
  textarea{min-height:88px}
  .row{display:flex;gap:16px;align-items:stretch} .col{flex:1}
  .toolbar{display:flex;justify-content:space-between;align-items:center;gap:12px;margin-top:12px}
  .right{display:flex;gap:8px}
  button{appearance:none;border:1px solid var(--line);background:#0f1c2e;color:var(--text);padding:10px 14px;border-radius:10px;font-weight:700;font-size:14px;cursor:pointer}
  button.primary{background:linear-gradient(180deg,var(--primary),var(--primary-2));border-color:var(--primary)}
  button.ghost{background:#0f1c2e;border-color:var(--line);color:#9cb3cc}
  .stepper{display:flex;gap:6px;flex-wrap:wrap}
  .step{padding:8px 12px;border:1px solid var(--line);border-radius:999px;font-size:12px;color:#9cb3cc;background:#0f1c2e}
  .step.active{border-color:var(--primary);color:#cfe2ff}
  table{border-collapse:collapse;width:100%}
  th,td{border-bottom:1px solid var(--line);padding:10px 12px;text-align:left;font-size:13px}
  th{color:#b7d0ff;font-weight:700;background:#0c1a2b}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12px;border:1px solid var(--line);background:#0b1a2a;padding:2px 6px;border-radius:6px}
  .tag{font-size:12px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);color:#c8dbf5;background:#0b1a2a;display:inline-block}
  .tag.ok{border-color:#1f6e4a;color:#9be5c8;background:#0b261c}
  .tag.bad{border-color:#6b1d1d;color:#ffbdbd;background:#2a0d0d}
  .tag.warn{border-color:#5e4100;color:#ffd788;background:#2a1c00}
  .row-green td{background:var(--row-green)}
  .row-red td{background:var(--row-red)}
  .note{font-size:12px;color:#9cb3cc}
  .divider{height:1px;background:var(--line);margin:14px 0}
  .matrix{overflow:auto;border:1px solid var(--line);border-radius:12px;background:#0f1c2e}
  .kpi{display:flex;flex-direction:column;gap:6px;padding:12px;border:1px solid var(--line);border-radius:12px;background:#0f1c2e}
  .kpi .big{font-weight:800;font-size:22px}
  .flow{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .flow .box{padding:8px 12px;border:1px solid var(--line);border-radius:10px;background:#0b1a2a}
  .arrow{opacity:.6}
  @media print{ body{background:#fff;color:#000} .no-print{display:none} }
  canvas{max-width:100%;background:#0b1a2a;border:1px solid var(--line);border-radius:12px;padding:8px}
</style>
</head>
<body>
<header>
  <div class="brand">
    <div class="logo">LOGO</div>
    <div>
      <h1>Klaedes Advisory • FuelEU Pooling Platform</h1>
      <div class="sub">Demo — calculator + statements (info-only) + billing stubs</div>
    </div>
  </div>

  <div class="demo-bar">
    <span class="demo-pill">Demo mode</span>
    <button class="ghost" onclick="loadSampleData()">Load Sample Data</button>
    <button class="ghost" onclick="resetDemo()">Reset Demo</button>
  </div>
</header>

<div class="wrap">
  <nav>
    <div class="nav">
      <div class="navtitle">Pooling flow</div>
      <div><button class="active" onclick="go(0)">1. Create Pool</button></div>
      <div><button onclick="go(1)">2. Invite Members</button></div>
      <div><button onclick="go(2)">3. Pool Agreement</button></div>
      <div><button onclick="go(3)">4. Attach Vessels</button></div>
      <div><button onclick="go(4)">5. Preview & Pricing</button></div>
      <div><button onclick="go(5)">6. Settlement Matrix</button></div>
      <div><button onclick="go(6)">7. Lock & Share</button></div>

      <div class="navtitle" style="margin-top:14px">Manage</div>
      <div><button onclick="nav('vessels')">Vessels (add/import)</button></div>
      <div><button onclick="nav('account')">Account & Org</button></div>
      <div><button onclick="nav('billing')">Billing (platform fees)</button></div>

      <div class="navtitle" style="margin-top:14px">Calculators</div>
      <div><button onclick="nav('calc')">Pool Calculator</button></div>

      <div class="navtitle" style="margin-top:14px">Tools</div>
      <div><button onclick="nav('dash')">Dashboards</button></div>
      <div><button onclick="nav('forecast')">Forecasting</button></div>
      <div><button onclick="nav('integrations')">Integrations</button></div>
      <div><button onclick="nav('synergy')">FuelEU ↔ ETS</button></div>
      <div><button onclick="nav('ledger')">Bank / Borrow</button></div>
      <div><button onclick="nav('admin')">Platform Admin</button></div>
    </div>
  </nav>
  <main id="screen"></main>
</div>

<script>
/* ------------------------ STATE ------------------------ */
const state = {
  step: 0,
  org: { name: 'Klaedes Shipping (demo)', email:'demo@klaedes.io' },
  targets: { 2025: 89.3, 2026: 86.8, 2027: 84.0 },
  fx: { eurusd: 1.10, mode:'auto' },
  vessels: JSON.parse(localStorage.getItem('vessels')||'[]'),
  pool:{ name:'2026 Global Pool', year:2026, coordinator:'Klaedes Shipping', coCoordinator:true},
  invites:[
    { org:'MedBlue Lines', role:'Member', status:'Accepted' },
    { org:'ArcticWave Shipping', role:'Member', status:'Pending' },
    { org:'EuroBulk Carriers', role:'Member', status:'Accepted' },
    { org:'Pacific Star Ferries', role:'Member', status:'Accepted' }
  ],
  pricing:{ basePerVesselEUR:250, percentOfSettlement:0.003, visibleToCoordinatorOnly:true },
  penaltyRatePerUnitEUR:0.0024,
  settlements:null,
  calcSel:null
};

/* ------------------------ HELPERS ------------------------ */
function save(){ localStorage.setItem('vessels', JSON.stringify(state.vessels)); }
function resetDemo(){ localStorage.removeItem('vessels'); state.vessels=[]; state.settlements=null; render(); alert('Demo reset.'); }
function renderStepper(){
  const steps = ['Create Pool','Invite Members','Pool Agreement','Attach Vessels','Preview & Pricing','Settlement Matrix','Lock & Share'];
  document.getElementById('stepper')?.remove(); // older header had stepper
}
function go(i){ state.step=i; render(); }
function nav(which){
  const el = document.getElementById('screen');
  if(which==='vessels'){ el.innerHTML = viewVessels(); }
  else if(which==='account'){ el.innerHTML = viewAccount(); }
  else if(which==='billing'){ el.innerHTML = viewBilling(); }
  else if(which==='calc'){ el.innerHTML = viewCalc(); }
  else if(which==='dash'){ el.innerHTML = `<div class="card"><h2>Dashboards</h2><p class="muted">Role-based KPIs.</p></div>`; }
  else if(which==='forecast'){ el.innerHTML = `<div class="card"><h2>Forecasting</h2><p class="muted">What-ifs coming soon.</p></div>`; }
  else if(which==='integrations'){ el.innerHTML = `<div class="card"><h2>Integrations</h2><p class="muted">EU MRV nightly; Voyages/E-logs real-time.</p></div>`; }
  else if(which==='synergy'){ el.innerHTML = `<div class="card"><h2>FuelEU ↔ ETS</h2><p class="muted">Compare EUA vs FuelEU abatement.</p></div>`; }
  else if(which==='ledger'){ el.innerHTML = `<div class="card"><h2>Banking/Borrowing</h2><p class="muted">Inter-year ledger.</p></div>`; }
  else if(which==='admin'){ el.innerHTML = viewAdmin(); }
}
function recompute(v){
  const target = state.targets[v.year] ?? 0;
  const delta = Number(v.achieved) - Number(target);
  v.balance = Math.round(delta * Number(v.energyMJ||0));
}

/* -------------------- SAMPLE DATA -------------------- */
function loadSampleData(){
  const demo = [
    { imo:'9321483', name:'MV Aegean Star', type:'Container', year:2026, energyMJ:5200000000, achieved:82.4, currency:'EUR', mode:'Pool' },
    { imo:'9745631', name:'MV Baltic Crest', type:'Bulk',      year:2026, energyMJ:4100000000, achieved:91.2, currency:'EUR', mode:'Pool' },
    { imo:'9783329', name:'LNG Aurora',      type:'LNG',       year:2026, energyMJ:6800000000, achieved:85.5, currency:'EUR', mode:'Pool' },
    { imo:'9312270', name:'EuroFerry One',   type:'Passenger', year:2026, energyMJ:3000000000, achieved:96.1, currency:'EUR', mode:'Standalone' },
    { imo:'9637742', name:'MedBlue Atlas',   type:'Container', year:2026, energyMJ:5900000000, achieved:84.9, currency:'EUR', mode:'Pool' },
    { imo:'9699912', name:'ArcticWave Nova', type:'Bulk',      year:2026, energyMJ:3600000000, achieved:88.7, currency:'EUR', mode:'Pool' }
  ];
  demo.forEach(v=>recompute(v));
  state.vessels = demo;
  save(); render();
  alert('Loaded 6 sample vessels with mixed surplus/deficit.');
}

/* -------------------- 7-STEP FLOW VIEWS -------------------- */
function viewCreate(){
  const p=state.pool;
  const flow = `
    <div class="flow">
      <div class="box">1. Create Pool</div><span class="arrow">→</span>
      <div class="box">2. Invite</div><span class="arrow">→</span>
      <div class="box">3. Agreement</div><span class="arrow">→</span>
      <div class="box">4. Attach Vessels</div><span class="arrow">→</span>
      <div class="box">5. Preview</div><span class="arrow">→</span>
      <div class="box">6. Settlement</div><span class="arrow">→</span>
      <div class="box">7. Share</div>
    </div>`;
  return `<div class="card">
    <h2>1. Create Pool</h2>
    <p class="muted">Set the year and roles. Demo data is local to your browser.</p>
    ${flow}
    <div class="row" style="margin-top:12px">
      <div class="col">
        <label>Pool name</label><input value="${p.name}" oninput="state.pool.name=this.value">
        <label>Year</label><select onchange="state.pool.year=+this.value; state.settlements=null; render()">
          <option ${p.year===2025?'selected':''}>2025</option>
          <option ${p.year===2026?'selected':''}>2026</option>
          <option ${p.year===2027?'selected':''}>2027</option>
        </select>
        <label>Coordinator</label><input value="${p.coordinator}" oninput="state.pool.coordinator=this.value">
        <label><input type="checkbox" ${p.coCoordinator?'checked':''} onclick="state.pool.coCoordinator=this.checked"> Enable co-coordinator</label>
      </div>
      <div class="col">
        <div class="kpi"><div class="muted">Mode</div><div class="big">Pooling & Solo</div></div>
        <div class="kpi"><div class="muted">Banking/Borrowing</div><div class="big">Enabled</div></div>
      </div>
    </div>
    <div class="toolbar"><span class="note">Tip: click “Load Sample Data” to see charts & statements.</span><div class="right"><button class="primary" onclick="go(1)">Continue →</button></div></div>
  </div>`;
}
function viewInvite(){ const rows = state.invites.map(r=>`
  <div class="row" style="align-items:center;border-bottom:1px solid var(--line);padding:10px 0">
    <div class="col"><strong>${r.org}</strong><div class="note">${r.role}</div></div>
    <div style="display:flex;gap:8px;align-items:center"><span class="tag ${r.status==='Accepted'?'ok':(r.status==='Pending'?'warn':'')}">${r.status}</span><button class="ghost">Resend</button></div>
  </div>`).join('');
  return `<div class="card">
    <h2>2. Invite Members</h2>
    <div class="row">
      <div class="col card">
        <label>Org email / ID</label><input placeholder="compliance@company.com">
        <label>Role</label><select><option>Member</option><option>Co-Coordinator</option></select>
        <div class="toolbar"><span class="note">Magic link invite (demo stub).</span><div class="right"><button>Send Invite</button></div></div>
      </div>
      <div class="col card">${rows}</div>
    </div>
    <div class="toolbar"><button class="ghost" onclick="go(0)">← Back</button><div class="right"><button class="primary" onclick="go(2)">Continue →</button></div></div>
  </div>`;
}
function viewAgreement(){
  return `<div class="card">
    <h2>3. Pool Agreement</h2>
    <p class="muted">BIMCO-style placeholders. Clause-level editing. E-sign stub.</p>
    <div class="row">
      <div class="col"><label>Clause: Pricing Terms</label><textarea>[Placeholder] Price floor/ceiling; Payment terms; Late penalties.</textarea></div>
      <div class="col"><label>E-sign</label><select><option>DocuSign</option><option>Adobe Sign</option></select><button style="margin-top:8px">Send for E-sign</button></div>
    </div>
    <div class="toolbar"><button class="ghost" onclick="go(1)">← Back</button><div class="right"><button class="primary" onclick="go(3)">Continue →</button></div></div>
  </div>`;
}
function viewAttach(){
  const rows = state.vessels
    .filter(v=>v.year==state.pool.year)
    .map(v=>{
      const statusClass = v.balance>0 ? 'row-green' : (v.balance<0 ? 'row-red' : '');
      return `<tr class="${statusClass}">
        <td><input type="checkbox" ${v.mode==='Pool'?'checked':''} onclick="v.mode=this.checked?'Pool':'Standalone';save();render();"></td>
        <td>${v.name}</td>
        <td class="note">${v.imo}</td>
        <td>${v.type}</td>
        <td class="kbd">${v.achieved}</td>
        <td class="kbd">${(state.targets[v.year]??0)}</td>
        <td class="kbd">${(v.balance??0).toLocaleString()}</td>
        <td><span class="tag ${v.balance>0?'ok':(v.balance<0?'bad':'warn')}">${v.balance>0?'Surplus':(v.balance<0?'Deficit':'Flat')}</span></td>
      </tr>`;
    }).join('') || `<tr><td colspan="8">No vessels for ${state.pool.year}. Go to “Vessels” to add/import or click “Load Sample Data”.</td></tr>`;
  return `<div class="card">
    <h2>4. Attach Vessels</h2>
    <p class="muted">Tick to include vessel in this pool. A vessel can’t be in two pools for the same year.</p>
    <div class="matrix"><table><thead><tr><th>In Pool</th><th>Vessel</th><th>IMO</th><th>Type</th><th>Achieved</th><th>Target</th><th>Balance units</th><th>Status</th></tr></thead><tbody>${rows}</tbody></table></div>
    <div class="toolbar"><button class="ghost" onclick="go(2)">← Back</button><div class="right"><button class="primary" onclick="go(4)">Continue →</button></div></div>
  </div>`;
}
function computeSettlements(){
  const selected = state.vessels.filter(v=>v.year==state.pool.year && v.mode==='Pool');
  const net = selected.reduce((a,b)=>a + (b.balance||0), 0);
  const creditors = selected.filter(v=>v.balance>0);
  const debtors = selected.filter(v=>v.balance<0).map(v=>({ ...v, amt:Math.abs(v.balance)}));
  const transfers=[]; let i=0,j=0; const c=creditors.map(v=>({org:v.owner||v.name, name:v.name, amt:v.balance}));
  while(i<c.length && j<debtors.length){
    const pay=Math.min(c[i].amt, debtors[j].amt);
    transfers.push({from:debtors[j].name, to:c[i].name, eur:pay, type:'Cash', inKind:''});
    c[i].amt-=pay; debtors[j].amt-=pay;
    if(c[i].amt<=1) i++; if(debtors[j].amt<=1) j++;
  }
  const volume = transfers.reduce((a,t)=>a+t.eur,0);
  const base = state.pricing.basePerVesselEUR * selected.length;
  const pct = volume * state.pricing.percentOfSettlement;
  state.settlements={ net, transfers, volume, fees:{base,pct,total:base+pct} };
}
function viewPreview(){
  computeSettlements();
  const s=state.settlements; const pen = Math.abs(s.net)*state.penaltyRatePerUnitEUR;

  // totals for chart
  const year = state.pool.year;
  const sel = state.vessels.filter(v=>v.year==year && v.mode==='Pool');
  const surplus = sel.reduce((a,v)=>a + Math.max(0,v.balance||0),0);
  const deficit = sel.reduce((a,v)=>a + Math.max(0,-(v.balance||0)),0);
  const coverage = deficit? surplus/deficit : 0;

  setTimeout(()=>{ drawBar('sdChart', surplus, deficit); drawGauge('covChart', coverage); }, 0);

  return `<div class="card">
    <h2>5. Preview & Pricing</h2>
    <div class="row">
      <div class="col kpi"><div class="muted">Net units</div><div class="big">${s.net.toLocaleString()}</div></div>
      <div class="col kpi"><div class="muted">€ at penalty rate</div><div class="big">€ ${pen.toLocaleString(undefined,{maximumFractionDigits:0})}</div></div>
      <div class="col kpi"><div class="muted">Settlement volume</div><div class="big">€ ${s.volume.toLocaleString()}</div></div>
      <div class="col kpi"><div class="muted">Platform fee (hybrid)</div><div class="big">€ ${s.fees.total.toLocaleString()}</div></div>
    </div>
    <div class="row" style="margin-top:12px">
      <div class="col card"><h3>Surplus vs Deficit</h3><canvas id="sdChart" width="480" height="220" aria-label="Surplus vs Deficit"></canvas></div>
      <div class="col card"><h3>Coverage Gauge</h3><canvas id="covChart" width="480" height="220" aria-label="Coverage"></canvas></div>
    </div>
    <div class="toolbar"><button class="ghost" onclick="go(3)">← Back</button><div class="right"><button class="primary" onclick="go(5)">Continue →</button></div></div>
  </div>`;
}
function viewSettlement(){
  const selParties = Array.from(new Set(state.vessels.filter(v=>v.year==state.pool.year && v.mode==='Pool').map(v=>v.owner||v.name)));
  const rows = (state.settlements?.transfers||[]).map(t=>`
    <tr><td>${t.from}</td><td>${t.to}</td><td class="kbd">€ ${t.eur.toLocaleString()}</td>
      <td><select onchange="t.type=this.value;render()"><option>Cash</option><option ${t.type==='In-kind'?'selected':''}>In-kind</option><option ${t.type==='Mixed'?'selected':''}>Mixed</option></select></td>
      <td><input value="${t.inKind|| (t.type==='Cash'?'—':'Cargo slots / 5 days')}" oninput="t.inKind=this.value"></td>
    </tr>`).join('') || `<tr><td colspan="5">No transfers (no pooled vessels).</td></tr>`;
  return `<div class="card">
    <h2>6. Settlement Matrix</h2>
    <div class="row">
      <div class="col card">
        <h3>FX</h3>
        <label>EUR→USD</label><input value="${state.fx.eurusd}" oninput="state.fx.eurusd=parseFloat(this.value)||1.1">
        <label>Mode</label><select onchange="state.fx.mode=this.value"><option ${state.fx.mode==='auto'?'selected':''}>auto</option><option ${state.fx.mode==='manual'?'selected':''}>manual</option></select>
        <p class="small muted">FX source appears on statements.</p>
      </div>
      <div class="col card">
        <h3>Platform Fee (coordinator-only)</h3>
        <div class="row">
          <div class="col kpi"><div class="muted">Base</div><div class="big">€ ${state.settlements.fees.base.toLocaleString()}</div></div>
          <div class="col kpi"><div class="muted">% fee</div><div class="big">€ ${state.settlements.fees.pct.toLocaleString()}</div></div>
          <div class="col kpi"><div class="muted">Total</div><div class="big">€ ${state.settlements.fees.total.toLocaleString()}</div></div>
        </div>
      </div>
    </div>
    <div class="matrix"><table><thead><tr><th>From</th><th>To</th><th>Amount (EUR)</th><th>Type</th><th>In-kind details</th></tr></thead><tbody>${rows}</tbody></table></div>

    <div class="divider"></div>
    <div class="row">
      <div class="col card">
        <h3>Settlement Statements (information-only)</h3>
        <div class="row">
          <div class="col"><button class="primary" onclick="generateStatementPDF()">Generate Pool Settlement Statement (PDF)</button></div>
          <div class="col">
            <label>Per-party</label>
            <select id="partySel">${selParties.map(p=>`<option>${p}</option>`).join('')}</select>
            <button onclick="generateStatementPDF(document.getElementById('partySel').value)">Generate Statement for Party</button>
          </div>
        </div>
        <p class="small muted">Statements translate surpluses/deficits into monetary terms (per FX) and show a “not an invoice” disclaimer.</p>
      </div>
      <div class="col card">
        <h3>Exports</h3>
        <button class="ghost" onclick="exportCSV()">CSV (transfers)</button>
        <button class="ghost" onclick="exportJSON()">JSON (transfers)</button>
      </div>
    </div>

    <div class="toolbar"><button class="ghost" onclick="go(4)">← Back</button><div class="right"><button class="primary" onclick="go(6)">Continue →</button></div></div>
  </div>`;
}
function viewLock(){ return `
  <div class="card"><h2>7. Lock & Share</h2>
    <p class="muted">Freeze, export verifier pack and offline export (stubs).</p>
    <div class="row">
      <div class="col card"><h3>Freeze & Snapshot</h3><button>Freeze Pool</button></div>
      <div class="col card"><h3>Exports</h3><button class="ghost">Verifier Pack</button> <button class="ghost">Offline Export</button></div>
    </div>
    <div class="toolbar"><button class="ghost" onclick="go(5)">← Back</button><div class="right"><button class="primary" onclick="alert('Done!')">Finish</button></div></div>
  </div>`; }

/* -------------------- VESSELS MANAGER -------------------- */
function addVessel(){
  const v = {
    imo:document.getElementById('v_imo').value.trim(),
    name:document.getElementById('v_name').value.trim(),
    type:document.getElementById('v_type').value,
    year:+document.getElementById('v_year').value,
    energyMJ:+document.getElementById('v_energy').value,
    achieved:+document.getElementById('v_achieved').value,
    currency:document.getElementById('v_curr').value,
    mode:document.getElementById('v_mode').value
  };
  if(!v.imo || !v.name){ alert('IMO and Name are required.'); return; }
  recompute(v); state.vessels.push(v); save(); render();
}
function importCSV(file){
  const reader = new FileReader();
  reader.onload = e=>{
    const rows = (e.target.result||'').toString().split(/\r?\n/).filter(Boolean);
    const header = rows.shift().split(',').map(h=>h.trim().toLowerCase());
    const idx = k=> header.findIndex(h=>h===k);
    rows.forEach(line=>{
      const c = line.split(',');
      const v = {
        imo:c[idx('imo')], name:c[idx('name')], type:c[idx('type')],
        year:+c[idx('year')], energyMJ:+c[idx('energymj')],
        achieved:+(c[idx('achievedintensity_gco2e_per_mj')]||c[idx('achieved_gco2e_per_mj')]),
        currency:c[idx('currency')]||'EUR', mode:'Standalone'
      };
      if(!v.imo) return;
      recompute(v); state.vessels.push(v);
    });
    save(); render(); alert('CSV imported.');
  };
  reader.readAsText(file);
}
function viewVessels(){
  const rows = state.vessels.map((v,i)=>{
    const rowClass = v.balance>0 ? 'row-green' : (v.balance<0 ? 'row-red' : '');
    return `
      <tr class="${rowClass}">
        <td>${v.name}</td><td class="note">${v.imo}</td><td>${v.type}</td><td>${v.year}</td>
        <td class="kbd">${v.achieved}</td><td class="kbd">${state.targets[v.year]??0}</td>
        <td class="kbd">${(v.energyMJ??0).toLocaleString()}</td>
        <td class="kbd">${(v.balance??0).toLocaleString()}</td>
        <td>
          <select onchange="state.vessels[${i}].mode=this.value; save(); render()">
            <option ${v.mode==='Pool'?'selected':''}>Pool</option>
            <option ${v.mode==='Standalone'?'selected':''}>Standalone</option>
          </select>
        </td>
        <td><button class="ghost" onclick="state.vessels.splice(${i},1); save(); render()">Remove</button></td>
      </tr>`;
  }).join('') || `<tr><td colspan="10">No vessels yet. Click “Load Sample Data” or add/import below.</td></tr>`;
  const yrOpts = [2025,2026,2027].map(y=>`<option>${y}</option>`).join('');
  return `<div class="card">
    <h2>Vessels (add/import & compute)</h2>
    <p class="muted">Green = surplus; Red = deficit. We compute balance = (Achieved − Target) × Energy (MJ).</p>
    <div class="row">
      <div class="col card">
        <h3>Add vessel</h3>
        <label>IMO</label><input id="v_imo" placeholder="1234567">
        <label>Name</label><input id="v_name" placeholder="MV Example">
        <label>Type</label><select id="v_type"><option>Container</option><option>Bulk</option><option>LNG</option><option>Passenger</option></select>
        <label>Year</label><select id="v_year">${yrOpts}</select>
        <label>Energy (MJ)</label><input id="v_energy" type="number" step="1" placeholder="5000000000">
        <label>Achieved (gCO₂e/MJ)</label><input id="v_achieved" type="number" step="0.01" placeholder="88.2">
        <label>Currency</label><select id="v_curr"><option>EUR</option><option>USD</option></select>
        <label>Mode</label><select id="v_mode"><option>Pool</option><option selected>Standalone</option></select>
        <div class="toolbar"><span class="note">Auto-calc balance units.</span><div class="right"><button onclick="addVessel()">Add</button></div></div>
      </div>
      <div class="col card">
        <h3>Import from CSV (verifier export)</h3>
        <p class="muted small">Columns: IMO,Name,Type,Year,EnergyMJ,AchievedIntensity_gCO2e_per_MJ,Currency</p>
        <input type="file" accept=".csv" onchange="importCSV(this.files[0])">
        <div class="divider"></div>
        <h3>Targets (editable)</h3>
        <label>2025</label><input value="${state.targets[2025]}" oninput="state.targets[2025]=+this.value; state.vessels.forEach(recompute); save();">
        <label>2026</label><input value="${state.targets[2026]}" oninput="state.targets[2026]=+this.value; state.vessels.forEach(recompute); save();">
        <label>2027</label><input value="${state.targets[2027]}" oninput="state.targets[2027]=+this.value; state.vessels.forEach(recompute); save();">
      </div>
    </div>
    <div class="matrix"><table><thead><tr><th>Vessel</th><th>IMO</th><th>Type</th><th>Year</th><th>Achieved</th><th>Target</th><th>Energy (MJ)</th><th>Balance units</th><th>Mode</th><th>Actions</th></tr></thead><tbody>${rows}</tbody></table></div>
  </div>`;
}

/* -------------------- ACCOUNT / ADMIN / BILLING -------------------- */
function viewAccount(){ return `
  <div class="card">
    <h2>Account & Organization</h2>
    <div class="row">
      <div class="col card">
        <h3>Create account (demo)</h3>
        <label>Email</label><input value="${state.org.email}">
        <label>Password</label><input type="password" value="••••••••" />
        <button style="margin-top:8px">Create account</button>
      </div>
      <div class="col card">
        <h3>Organization</h3>
        <label>Name</label><input value="${state.org.name}">
        <label>Invite user</label><input placeholder="user@company.com"><button style="margin-top:8px">Send invite</button>
      </div>
    </div>
  </div>`;
}
function viewAdmin(){ return `
  <div class="card"><h2>Platform Admin</h2>
    <label>Base fee per vessel (EUR)</label><input value="${state.pricing.basePerVesselEUR}" oninput="state.pricing.basePerVesselEUR=+this.value;render()">
    <label>% of settlement</label><input value="${(state.pricing.percentOfSettlement*100).toFixed(2)}%" oninput="state.pricing.percentOfSettlement=parseFloat(this.value)/100;render()">
    <label><input type="checkbox" ${state.pricing.visibleToCoordinatorOnly?'checked':''} onclick="state.pricing.visibleToCoordinatorOnly=this.checked"> Coordinator-only fee visibility</label>
  </div>`;
}
function viewBilling(){
  const s = state.settlements || { fees:{base:0,pct:0,total:0} };
  const rows = `
    <tr><td>2026-08-01</td><td>Platform fee (base)</td><td class="kbd">€ ${s.fees.base.toLocaleString()}</td><td><button class="ghost" onclick="alert('Stripe Checkout (stub)')">Pay</button></td></tr>
    <tr><td>2026-08-01</td><td>Platform fee (% of settlement)</td><td class="kbd">€ ${s.fees.pct.toLocaleString()}</td><td><button class="ghost" onclick="alert('Stripe Checkout (stub)')">Pay</button></td></tr>
  `;
  return `<div class="card">
    <h2>Billing (platform fees)</h2>
    <p class="muted">Coordinators pay platform fees here. Member-to-member settlement is off-platform; use the information statements from Step 6.</p>
    <div class="matrix"><table><thead><tr><th>Date</th><th>Description</th><th>Amount</th><th>Action</th></tr></thead><tbody>${rows}</tbody></table></div>
    <div class="toolbar"><span class="note">Stripe in MVP: invoices + SEPA/card, VAT via Stripe Tax.</span><div class="right"><button class="primary" onclick="alert('Open Stripe Customer Portal (stub)')">Open Customer Portal</button></div></div>
  </div>`;
}

/* --------------- POOL EFFICIENCY CALCULATOR --------------- */
function computeWeighted(vLogs){
  const E = vLogs.reduce((a,b)=>a + (b.energyMJ||0), 0);
  if(!E) return { achieved: 0, energyMJ: 0 };
  const achieved = vLogs.reduce((a,b)=>a + (b.achieved*(b.energyMJ||0)), 0) / E;
  return { achieved, energyMJ: E };
}
function importPoolLogs(file){
  const reader = new FileReader();
  reader.onload = e=>{
    const rows = (e.target.result||'').toString().split(/\r?\n/).filter(Boolean);
    const header = rows.shift().split(',').map(x=>x.trim().toLowerCase());
    const idx = k => header.findIndex(h=>h===k);
    const grouped = {};
    rows.forEach(line=>{
      const c = line.split(',');
      const imo = (c[idx('imo')]||'').trim();
      if(!imo) return;
      grouped[imo] = grouped[imo] || [];
      grouped[imo].push({
        month: c[idx('month')],
        energyMJ: +c[idx('energymj')] || 0,
        achieved: +c[idx('achieved_gco2e_per_mj')] || +c[idx('achievedintensity_gco2e_per_mj')] || 0
      });
    });
    (state.vessels||[]).forEach(v=>{
      if(grouped[v.imo]){
        const w = computeWeighted(grouped[v.imo]);
        v.energyMJ = Math.round(w.energyMJ);
        v.achieved = +w.achieved.toFixed(2);
        recompute(v);
      }
    });
    save(); render();
    alert('Logs imported. Balances recalculated from last 12 months.');
  };
  reader.readAsText(file);
}
function poolEfficiency(selected){
  const surplus = selected.reduce((a,v)=> a + Math.max(0, v.balance||0), 0);
  const deficit = selected.reduce((a,v)=> a + Math.max(0, -(v.balance||0)), 0);
  const coverage = deficit ? surplus/deficit : Infinity;
  const stressCoverage = deficit ? (surplus*0.90) / (deficit*1.05) : Infinity;
  let verdict = "Fail", level="bad";
  if(coverage >= 1.20){ verdict = "Strong Pass"; level="ok"; }
  else if(coverage >= 1.00){ verdict = "Pass"; level="ok"; }
  else if(coverage >= 0.80){ verdict = "Marginal"; level="warn"; }
  return { surplus, deficit, coverage, stressCoverage, verdict, level };
}
function calculatorSuggestions(selected, all){
  const chosenIds = new Set(selected.map(v=>v.imo));
  const notChosen = all.filter(v=>!chosenIds.has(v.imo));
  const extraSurplus = notChosen.filter(v=> (v.balance||0) > 0).sort((a,b)=> (b.balance||0)-(a.balance||0)).slice(0,3);
  const worstDeficit = selected.filter(v=> (v.balance||0)<0).sort((a,b)=> (a.balance||0)-(b.balance||0))[0];
  return { add: extraSurplus, focus: worstDeficit };
}
function viewCalc(){
  const year = state.pool?.year || 2026;
  const all = (state.vessels||[]).filter(v=>v.year==year);
  if(!state.calcSel) state.calcSel = new Set(all.filter(v=>v.mode==='Pool').map(v=>v.imo));
  const sel = all.filter(v=>state.calcSel.has(v.imo));

  const ef = poolEfficiency(sel);
  const sugg = calculatorSuggestions(sel, all);

  const rows = all.map(v=>{
    const rc = v.balance>0?'row-green':(v.balance<0?'row-red':'');
    return `
    <tr class="${rc}">
      <td><input type="checkbox" ${state.calcSel.has(v.imo)?'checked':''} onclick="this.checked?state.calcSel.add('${v.imo}'):state.calcSel.delete('${v.imo}'); render()"></td>
      <td>${v.name}</td><td class="note">${v.imo}</td><td>${v.type||''}</td>
      <td class="kbd">${v.achieved??''}</td><td class="kbd">${state.targets?.[v.year]??''}</td>
      <td class="kbd">${(v.energyMJ??0).toLocaleString()}</td>
      <td class="kbd">${(v.balance??0).toLocaleString()}</td>
      <td><span class="tag ${v.balance>0?'ok':(v.balance<0?'bad':'warn')}">${v.balance>0?'Surplus':(v.balance<0?'Deficit':'Flat')}</span></td>
    </tr>`;
  }).join('') || `<tr><td colspan="9">No vessels for ${year}. Add/import in “Vessels”.</td></tr>`;

  const cov = isFinite(ef.coverage) ? (ef.coverage*100).toFixed(0)+'%' : '—';
  const scv = isFinite(ef.stressCoverage) ? (ef.stressCoverage*100).toFixed(0)+'%' : '—';
  const badge = `tag ${ef.level}`;

  return `
  <div class="card"><h2>Pool Efficiency Calculator</h2>
    <p class="muted">Import 12-month logs, select vessels, and see if your pool will cover deficits. We recompute balances using weighted intensity across the year.</p>

    <div class="row">
      <div class="col card">
        <h3>Import last 12 months</h3>
        <p class="small muted">CSV: <code>IMO,Month,EnergyMJ,Achieved_gCO2e_per_MJ</code></p>
        <input type="file" accept=".csv" onchange="importPoolLogs(this.files[0])">
      </div>
      <div class="col card">
        <h3>Result</h3>
        <div class="row">
          <div class="col kpi"><div class="muted">Total surplus</div><div class="big">${(ef.surplus||0).toLocaleString()} u</div></div>
          <div class="col kpi"><div class="muted">Total deficit</div><div class="big">${(ef.deficit||0).toLocaleString()} u</div></div>
          <div class="col kpi"><div class="muted">Coverage</div><div class="big">${cov}</div></div>
          <div class="col kpi"><div class="muted">Stress coverage</div><div class="big">${scv}</div></div>
        </div>
        <p>Verdict: <span class="${badge}">${ef.verdict}</span></p>
      </div>
    </div>

    <div class="card"><h3>Build your candidate pool</h3>
      <div class="matrix"><table>
        <thead><tr><th>Use</th><th>Vessel</th><th>IMO</th><th>Type</th><th>Achieved</th><th>Target</th><th>Energy (MJ)</th><th>Balance</th><th>Status</th></tr></thead>
        <tbody>${rows}</tbody>
      </table></div>
    </div>
  </div>`;
}

/* -------------------- STATEMENT EXPORTS -------------------- */
function exportCSV(){
  const headers = ['From','To','AmountEUR','Type','InKind'];
  const rows = (state.settlements?.transfers||[]).map(t=>[t.from,t.to,t.eur,t.type,(t.inKind||'')]);
  const csv = [headers.join(','), ...rows.map(r=>r.map(x=>`"${String(x).replace(/"/g,'""')}"`).join(','))].join('\n');
  const url = URL.createObjectURL(new Blob([csv],{type:'text/csv'}));
  const a=document.createElement('a'); a.href=url; a.download='pool_transfers.csv'; a.click(); URL.revokeObjectURL(url);
}
function exportJSON(){
  const payload = { pool: state.pool, fx: state.fx, transfers: state.settlements?.transfers||[] };
  const url = URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:'application/json'}));
  const a=document.createElement('a'); a.href=url; a.download='pool_transfers.json'; a.click(); URL.revokeObjectURL(url);
}

/* ------------ INFORMATION-ONLY STATEMENT (printable) ------------ */
function generateStatementPDF(partyName){
  if(!state.settlements){ computeSettlements(); }
  const s = state.settlements;
  const date = new Date().toISOString().slice(0,10);
  const title = partyName ? `Settlement Statement — ${partyName}` : 'Settlement Statement — Pool';
  const fx = `FX basis: ${state.fx.mode==='auto'?'ECB (auto)':'Manual (agreed)'} • EUR→USD ${state.fx.eurusd}`;
  const transfers = s.transfers.filter(t=> !partyName || t.from===partyName || t.to===partyName );

  const totals = transfers.reduce((acc,t)=>{
    acc.out += partyName && t.from===partyName ? t.eur : 0;
    acc.in  += partyName && t.to===partyName   ? t.eur : 0;
    return acc;
  }, {in:0,out:0});

  const tableRows = transfers.map(t=>`
    <tr>
      <td>${t.from}</td>
      <td>${t.to}</td>
      <td style="text-align:right">€ ${t.eur.toLocaleString()}</td>
      <td>${t.type}</td>
      <td>${t.inKind||''}</td>
    </tr>`).join('') || `<tr><td colspan="5">No transfers for selection.</td></tr>`;

  const style = `
    <style>
      body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial;margin:32px;color:#0b2845}
      h1{font-size:20px;margin:0} .muted{color:#5b7894}
      table{border-collapse:collapse;width:100%;margin-top:12px}
      th,td{border-bottom:1px solid #e6eef5;padding:8px 10px;text-align:left;font-size:12px}
      th{background:#f2f7fc}
      .kpi{display:inline-block;margin-right:16px;font-size:13px}
      .box{border:1px solid #e6eef5;border-radius:10px;padding:12px;margin-top:10px}
      .note{font-size:11px;color:#5b7894;margin-top:12px}
      .header{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:8px}
      .stamp{font-size:11px;border:1px solid #e6eef5;padding:4px 8px;border-radius:999px;background:#f9fbff}
    </style>`;

  const html = `
    <!DOCTYPE html>
    <html><head><meta charset="utf-8">${style}</head><body>
      <div class="header">
        <div>
          <h1>${title}</h1>
          <div class="muted">${state.pool.name} • Year ${state.pool.year}</div>
          <div class="muted">Coordinator: ${state.pool.coordinator}</div>
        </div>
        <div>
          <div class="stamp">Generated ${date}</div>
          <div class="stamp" style="margin-top:6px">${fx}</div>
        </div>
      </div>

      <div class="box">
        <div class="kpi"><strong>Total settlement volume:</strong> € ${s.transfers.reduce((a,t)=>a+t.eur,0).toLocaleString()}</div>
        ${partyName? `
          <div class="kpi"><strong>Receivable for ${partyName}:</strong> € ${totals.in.toLocaleString()}</div>
          <div class="kpi"><strong>Payable by ${partyName}:</strong> € ${totals.out.toLocaleString()}</div>` : ``}
      </div>

      <table>
        <thead>
          <tr><th>From</th><th>To</th><th style="text-align:right">Amount (EUR)</th><th>Type</th><th>In-kind details</th></tr>
        </thead>
        <tbody>${tableRows}</tbody>
      </table>

      <div class="box">
        <div><strong>Notes:</strong></div>
        <ul>
          <li>Amounts translate FuelEU surpluses/deficits into monetary terms based on the pool’s FX setting.</li>
          <li>${fx}.</li>
          <li>In-kind entries show agreed non-cash consideration (with optional monetary equivalent recorded).</li>
        </ul>
      </div>

      <div class="note">
        This Settlement Statement is for information only and is <strong>not an invoice</strong> or proof of payment.
        Settlement between parties occurs outside the platform per the Pool Agreement.
      </div>
    </body></html>
  `;

  const w = window.open('', '_blank');
  w.document.write(html);
  w.document.close();
  w.addEventListener('load', () => { w.focus(); w.print(); });
  setTimeout(() => { try { w.focus(); w.print(); } catch (e) {} }, 600);
}

/* -------------------- MINI-CHARTS -------------------- */
function drawBar(id, surplus, deficit){
  const c=document.getElementById(id); if(!c) return; const ctx=c.getContext('2d'); const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const max=Math.max(surplus,deficit,1);
  const bw=120, gap=80, baseY=H-30, scale=(H-80)/max;
  // axes
  ctx.strokeStyle='#2b3b55'; ctx.beginPath(); ctx.moveTo(40,baseY); ctx.lineTo(W-20,baseY); ctx.stroke();
  // bars
  ctx.fillStyle='#33d69f'; ctx.fillRect(80, baseY - surplus*scale, bw, surplus*scale);
  ctx.fillStyle='#ff5c5c'; ctx.fillRect(80+bw+gap, baseY - deficit*scale, bw, deficit*scale);
  // labels
  ctx.fillStyle='#cfe2ff'; ctx.font='12px system-ui';
  ctx.fillText('Surplus', 80, baseY+16);
  ctx.fillText('Deficit', 80+bw+gap, baseY+16);
  ctx.textAlign='center';
  ctx.fillText(surplus.toLocaleString(), 80+bw/2, baseY - surplus*scale - 8);
  ctx.fillText(deficit.toLocaleString(), 80+bw+gap+bw/2, baseY - deficit*scale - 8);
}
function drawGauge(id, coverage){
  const c=document.getElementById(id); if(!c) return; const ctx=c.getContext('2d'); const W=c.width, H=c.height;
  ctx.clearRect(0,0,W,H);
  const cx=W/2, cy=H-20, r=Math.min(W,H)-60;
  // arc background
  ctx.lineWidth=16; ctx.strokeStyle='#2b3b55'; ctx.beginPath(); ctx.arc(cx,cy, r/2, Math.PI, 2*Math.PI); ctx.stroke();
  // arc value
  const val=Math.max(0, Math.min(coverage, 1.4)); // cap at 140%
  const end=Math.PI + (Math.PI*val/1.4);
  ctx.strokeStyle= coverage>=1 ? '#33d69f' : (coverage>=0.8 ? '#ffb020' : '#ff5c5c');
  ctx.beginPath(); ctx.arc(cx,cy, r/2, Math.PI, end); ctx.stroke();
  // text
  ctx.fillStyle='#cfe2ff'; ctx.font='20px system-ui'; ctx.textAlign='center';
  const pct = isFinite(coverage) ? Math.round(coverage*100)+'%' : '—';
  ctx.fillText(pct, cx, cy-8);
}

/* -------------------- RENDER -------------------- */
function render(){
  const views=[viewCreate,viewInvite,viewAgreement,viewAttach,viewPreview,viewSettlement,viewLock];
  if(state.step>=4 && !state.settlements) computeSettlements();
  document.getElementById('screen').innerHTML = views[state.step]();
}
render();
</script>
</body>
</html>
